#!/bin/sh
  
SCRIPT_DIR="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# set up working directory

cd $SCRIPT_DIR

cd ..

set -e
arg1=$1
lib=${arg1%.*}

source bin/tauconfig.sh

usesX=$(grep  "^$lib.libsrc uses= " built/decs.txt | cut -d" " -f3-)

baselib="${usesX%%\ *}"
uses="${usesX#*\ }"

ccode="void init_libs(){"
for  n in $uses $baselib
 do
  dependlibs="$dependslib built/$n.dylib"
  dependlibs2="$dependlibs2 built/$n.bc"
  ccode=" void init_$n(); $ccode init_$n();"
done

if [ -z $baselib ]; then
 baselib="stdlib"
fi
built/$tauDylib$baselib $lib   > "tmp/$lib.html"
line1=$(awk '/^Finished/  {print "OK"}' tmp/$lib.html)
if [ "$line1" == "OK" ]; then 
 if [ -z "$tauDylib"   ];then 
  echo "void init_$lib(); $ccode init_$lib();}" > built/$lib.c
  cmd="clang -lm -pthread stdlib/*.c built/$lib.c   $dependlibs2  built/$lib.bc  -o built/$lib"
 echo $cmd
 $cmd
 else
   cmd="clang -lm -pthread -dynamiclib built/$lib.bc $dependlibs  -o built/$lib.dylib  -init _init_$lib -undefined dynamic_lookup" else
 echo $cmd
 $cmd
 fi
 echo "done" > built/$lib.lib
else
 $tauopen tmp/$lib.html
fi
